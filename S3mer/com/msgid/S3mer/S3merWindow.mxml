<?xml version="1.0" encoding="utf-8"?>
<mx:Window xmlns:mx="http://www.adobe.com/2006/mxml" showStatusBar="false"
	verticalScrollPolicy="off" 
	horizontalScrollPolicy="off" 
	visible="true" horizontalAlign="center" 
	verticalAlign="middle" cornerRadius="0" layout="absolute"
	backgroundColor="#000000"
	resize="onWindowResize(event)"
	 xmlns:ns1="com.msgid.S3mer.*">
	
	<mx:Script>
		<![CDATA[
			import mx.controls.Image;
			import mx.core.BitmapAsset;
			import mx.graphics.codec.PNGEncoder;
			import mx.graphics.codec.JPEGEncoder;
			import mx.events.EffectEvent;
			import mx.events.TweenEvent;
			import mx.events.ResizeEvent;
			import mx.managers.SystemManager;
			
			private var _screenNumber:int;
			private var _show:Show;
			private var _log:Logger = Logger.instance;
			private var _configuration:ConfigurationManager;
			private var _fader:FadePanel;
			private var _loaderShown:Boolean = false;
			private var _stopped:Boolean = true;
			private var _owner:S3mer;
			
			[Embed(source="assets/logo.swf")]
			[Bindable]
			public static var LogoSwf:Class;

			[Embed(source="assets/register.png")]
			[Bindable]
			public static var StaticSwf:Class;
			
			
			public function set show(myShow:Show):void {
				this._show = myShow;
				
				this.onWindowResize(null);
			}
			public function get show():Show{
				return _show;
			}
			
			public function get screenId():int {
				return this._screenNumber;
			}
			
			public function set ObjOwner(myOwner:S3mer):void {
				this._owner = myOwner;
			}
			
			public function get configuration():ConfigurationManager {
				return this._configuration;
			}
			
			public function set stopped(value:Boolean):void {
				_stopped = value;
			}
			
			//Receives screenNumber in which to display this screen, returns screenNumber or -1
			public function setScreen(screenNumber:int):int {
				var _screen:Screen;
				
				if ( screenNumber >= Screen.screens.length ) {
					return -1;
				} 
				
				_screen = Screen.screens[screenNumber];
				
				this.bounds = _screen.bounds;
				this._screenNumber = screenNumber;
				
				return screenNumber;
			}
			
			public function getScreen():int {
				return this._screenNumber;
			}
			
			public function showWindow():void {
				var _screen:Screen = Screen.screens[this._screenNumber];
				
				this.setStyle("backgroundColor","#FFFFFF");				
				this.visible = true;

				this.move(_screen.bounds.x,_screen.bounds.y);
				
				this._log.addEventListener(Event.ADDED, onLogUpdate,false,0,true);
				
				this.title = "Screen #" + this._screenNumber;
				this.screenNumber.text = "Screen #" + this._screenNumber;
				this.stage.displayState = StageDisplayState.FULL_SCREEN_INTERACTIVE;


				this.LoadingCanvas.visible = false;
				this.myLoadingStatic.source = StaticSwf;
				this.myLoadingStatic.maintainAspectRatio = false;
				this.myLoadingStatic.visible = false;
				this.setChildIndex(this.myLoadingStatic,this.numChildren-1);
			}
			
			public function enableKeyHandler():void {
				if ( !this.stage.willTrigger(KeyboardEvent.KEY_UP) ) {
					this.stage.addEventListener(KeyboardEvent.KEY_UP,HandleKeyUp,false,0,true);
				}
			}
			
			public function disableKeyHandler():void {
				this.stage.removeEventListener(KeyboardEvent.KEY_UP,HandleKeyUp);				
			}
			
			private function HandleKeyUp(e:KeyboardEvent):void {
				KeyboardManager.HandleKeyUp(e,this);
			}
						
			private function onWindowResize(e:ResizeEvent):void {
				Logger.addEvent("Screen #" + this._screenNumber + " size is: " + this.width + "x" + this.height);
				
				if( this._show != null ) {
					Logger.addEvent("Screen #" + this._screenNumber + ": resizing");
					this._show.width = this.width;
					this._show.height = this.height;
					this._show.resize();
				} else {
					Logger.addEvent("Screen #" + this._screenNumber + ": NOT resizing, show is null");
				}
			}
			
			private function onLogUpdate(e:Event):void {
				this.appLog.text = Logger.log;
			}

			public function OnHideLogComplete(e:TweenEvent):void {
				e.target.removeEventListener(TweenEvent.TWEEN_END,OnHideLogComplete);
				this.appLog.visible = false;
			}
			
			public function loadConfiguration():void {
				this.myLoadingStatic.visible = false;
				this.LoadingCanvas.visible = true;
				this.screenNumber.visible = false;

				this.setStyle("backgroundColor","#FFFFFF");				
				
				myLoadingImage.source = LogoSwf;
				myLoadingImage.maintainAspectRatio = true;

				LoadingCanvas.visible = true;

				this._configuration = new ConfigurationManager(this);
				
				this._configuration.addEventListener(ConfigurationEvent.UPDATED, OnConfigurationUpdate,false,0,true);
				this._configuration.addEventListener(DownloaderEvent.PARTIAL_COMPLETE, OnDownloadProgress,false,0,true);
				this._configuration.addEventListener(DownloaderEvent.PROGRESS, OnDownloadProgress,false,0,true);				
				
				this._configuration.updateConfiguration();
				
			}
			
			public function play():void {
				this.myLoadingStatic.visible = false;
				this.LoadingCanvas.visible = false;
				this._stopped = false;
				this._configuration.play();
			}

			private function OnConfigurationUpdate(e:ConfigurationEvent):void {
				
				if (_loaderShown == false) {
					myFileProgress.setProgress(100,100);
					myTotalProgress.setProgress(100,100);
					
					_fader = new FadePanel();
					
					_fader.setup(this);
					_fader.addEventListener(EffectEvent.EFFECT_END, OnFadeComplete);
	
					_fader.fadeOut(1000);
					_loaderShown = true;
				} else {
					this.setStyle("backgroundColor","#000000");
					this.LoadingCanvas.visible = false;
					this.play();
				}
				
				this.enableKeyHandler();
			}
			
			private var pictureTimer:Timer;

			private function snagPic(e:Event):void {
				return;
				
				var bitmapData:BitmapData;
				var newImage:File;
				var fileStream:FileStream;
				
				bitmapData = new BitmapData(this.width,this.height,false,0x00000000);
				bitmapData.draw(this,new Matrix());
				var bitmap:Bitmap = new Bitmap(bitmapData);

				this._notificationPanel.showNotification("Thumbnail");				
				
				var jpg:PNGEncoder = new PNGEncoder();
				
				var ba:ByteArray = jpg.encode(bitmapData);
//				var ba:ByteArray = bitmap..encode(bitmapData);
				newImage = File.applicationStorageDirectory.resolvePath("cap"+ this._screenNumber +".png");
				fileStream = new FileStream();
				fileStream.open(newImage, FileMode.UPDATE);
				fileStream.writeBytes(ba);
				fileStream.close();
			}
			
			private function OnFadeComplete(e:EffectEvent):void {
				_fader.removeEventListener(EffectEvent.EFFECT_END, OnFadeComplete);
				_fader.addEventListener(EffectEvent.EFFECT_END, OnFadeComplete_stage2);
				
				Logger.addEvent("Current BKG Color : " + this.getStyle("backgroundColor"));
				this.setStyle("backgroundColor","#000000");
				Logger.addEvent("Current BKG Color : " + this.getStyle("backgroundColor"));
				this.LoadingCanvas.visible = false;
				
				_fader.fadeIn(100);
			}
			
			private function OnFadeComplete_stage2(e:EffectEvent):void {
				_fader.removeEventListener(EffectEvent.EFFECT_END, OnFadeComplete_stage2);
				this.removeChild(_fader);
				
				if (this._stopped == true) {
					this._stopped = false;
					this.play();
				}
				
				pictureTimer = new Timer(1000,1);
				pictureTimer.addEventListener(TimerEvent.TIMER,snagPic);
				pictureTimer.start();
			}
			
			private function OnDownloadProgress(e:DownloaderEvent):void {
				this.myTotalProgress.setProgress(DownloadQueue(e._downloader).percent,100);
			}
			
			public function stop():void {
				this._configuration.stop();
				this._show = null;
				this._configuration = null;
				this._fader = null;
			}

			public function reloadApp():void {
				this._owner.reloadApp();
			}
			
			public function resetApp():void {
				this._owner.resetApp();
			}
			
			public function doReload():void {
				this._show.reset();
				this._show.removeAllChildren();
				this.removeChild(this._show);
				this.setStyle("backgroundColor","#FFFFFF");				
										
				this.loadConfiguration();
			}
			
			public function clean_stage1():void {
				this._show.reset();
				this._show.removeAllChildren();
				if (this._show.parent == this ) {
					this.removeChild(this._show);
				}
				this.setStyle("backgroundColor","#FFFFFF");				
			}
			
			public function clean_stage2():void {
				this.loadConfiguration();
			}
			
			public function doReset(loginWindow:LoginWindow):void {
				try {
				} catch(e:Error) {
					
				}

				if( this._show != null ) {				
					try {
						this._show.reset();
						this._show.removeAllChildren();
						this.removeChild(this._show);
					} catch(e:Error) {
						
					}
				}
				
				this._configuration.stopDownloads();
				this.LoadingCanvas.visible = false;
				
				this.setStyle("backgroundColor","#FFFFFF");				
										
				if( this._screenNumber == 0 ) {
					this.addChild(loginWindow);
				}
			}

			public function redoInitialSetup():void {
				this._owner.doInitialSetup(true);
			}
		
			public function displayImage(img:File):void {
				var _img:Image = new Image();

				_img.x = 0;
				_img.y = 0;
				_img.width = this.width;
				_img.height = this.height
				_img.maintainAspectRatio = false;
				_img.source = img.url;
				
				this.addChild(_img);
				
			}
			
			public function cleanMediaDirectory():void {
				this._owner.cleanMediaDirectory();	
			}
			
		]]>
	</mx:Script>
	
	<mx:constraintRows>
		<mx:ConstraintRow id="WindowedApplication1_row1" height="40%"/>
		<mx:ConstraintRow id="WindowedApplication1_row3" height="20%"/>
		<mx:ConstraintRow id="WindowedApplication1_row2" height="39.0%"/>
	</mx:constraintRows>
	<mx:constraintColumns>
		<mx:ConstraintColumn id="WindowedApplication1_col1" width="40%"/>
		<mx:ConstraintColumn id="WindowedApplication1_col3" width="20%"/>
		<mx:ConstraintColumn id="WindowedApplication1_col2" width="38.1%"/>
	</mx:constraintColumns>

	
	<mx:Label visible="false" id="screenNumber" text="Screen #" fontSize="36" fontFamily="Georgia" fontWeight="bold" horizontalCenter="0" verticalCenter="0"/>
	<ns1:NotificationPanel id="_notificationPanel" right="10" top="10" visible="false">
	</ns1:NotificationPanel>
	<mx:TextArea visible="false" height="116" wordWrap="true" editable="false" enabled="true" id="appLog" color="#000000" cornerRadius="0" alpha="0.5" borderStyle="none" borderThickness="8" left="13" right="12" bottom="10"/>
	<mx:Canvas left="WindowedApplication1_col3:0" right="WindowedApplication1_col3:0" top="WindowedApplication1_row3:0" bottom="WindowedApplication1_row3:0" id="LoadingCanvas" verticalScrollPolicy="off" horizontalScrollPolicy="off" visible="true">
		<mx:constraintRows>
			<mx:ConstraintRow id="Canvas11_row3" height="85%"/>
			<mx:ConstraintRow id="Canvas14_row1" height="5%"/>
			<mx:ConstraintRow id="Canvas14_row2" height="10%"/>
		</mx:constraintRows>
		<mx:constraintColumns>
			<mx:ConstraintColumn id="Canvas14_col1" width="10%"/>
			<mx:ConstraintColumn id="Canvas14_col3" width="80%"/>
			<mx:ConstraintColumn id="Canvas14_col2" width="10%"/>
		</mx:constraintColumns>
		<mx:SWFLoader left="Canvas14_col3:0" top="0" right="Canvas14_col3:0" bottom="Canvas14_row1:0" id="myLoadingImage"/>
		<mx:ProgressBar left="0" bottom="Canvas14_row1:0" right="0" top="Canvas14_row1:0" labelPlacement="bottom" id="myFileProgress" enabled="true" mode="manual" label=" " visible="false"/>
		<mx:ProgressBar  left="0" bottom="0" right="0" top="Canvas14_row1:0" labelPlacement="bottom" id="myTotalProgress" enabled="true" mode="manual" label=" "/>
		<mx:Label id="lblStatus" visible="false" left="0" right="0" top="Canvas14_row2:0" color="#BDBDBD">
			
		</mx:Label>
	</mx:Canvas>
	<mx:SWFLoader  top="0" left="0" right="0" bottom="0" id="myLoadingStatic"/>

</mx:Window>
